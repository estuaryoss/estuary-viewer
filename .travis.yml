language: node_js
node_js:
  - 12

services:
  - docker

env:

before_install:
install:

deploy:
  provider: script
  script: bash docker_push.sh
  on:
    branch: master
    tags: true

before_script:
  - npm install
  - npm run build
  - docker build . -t dinutac/estuary-viewer:latest

script:
  - docker-compose -f docker-compose-entire_stack.yml pull
  - docker-compose -f docker-compose-entire_stack.yml up -d
  - sleep 60
  - docker ps
  #  - generate 2 deployments and 1 test run
  - docker exec -ti estuaryviewer_estuary-deployer_1 bash -c "curl -i http://estuary-deployer:8080/deploystart/alpine.yml/variables.yml"
  - docker exec -ti estuaryviewer_estuary-deployer_1 bash -c "curl -i http://estuary-deployer:8080/deploystart/alpine.yml/variables.yml"
  - docker exec -ti estuaryviewer_estuary-deployer_1 bash -c "
    curl -i
    --request POST 'http://estuary-testrunner:8080/teststart/100'
    --header 'Accept:application/json'
    --header 'Content-Type:text/plain'
    --data 'sleep 1\nsleep 2\nsleep 3600'"
  - docker exec estuary-viewer sh -c "cd /home/node/app/; npm test"
  - docker ps


